#! /usr/bin/env bash

set -e

echo "newts installs a new typescript project in your current directory"
echo ""

project_name=$1
project_dir="$(pwd)/$project_name"

if [ -z $project_name ]; then
  echo "Please supply a name to create a new project"
  echo "E.g. $ newts foo_project"
  echo ""
  exit 1
fi

echo "Creating project: $project_name"

echo "Creating project in ${project_dir}..."
git clone --quiet https://github.com/cblanc/enceladus.git $project_dir >/dev/null
echo "github.com/cblanc/enceladus cloned into ${project_dir}"
echo ""

echo "Initialising a new repo in repository..."
rm -rf "$project_dir/.git"
git init $project_dir
echo "Git repository created"
echo ""

echo "Updating README.md"
sed -i -e "s/enceladus/$project_name/g" "$project_dir/README.md"

echo "Updating package.json"
sed -i -e "s/enceladus/$project_name/g" "$project_dir/package.json"

echo "Installing node dependencies via npm..."
mkdir -p "$project_dir/node_modules"
npm install --quiet --prefix $project_dir >/dev/null
echo "Dependencies installed"
echo ""

echo "Changing into project directory and checking scaffold tests pass"
cd $project_dir
npm test >/dev/null
echo "Tests have passed"
echo ""

echo "All done"
echo "Ready for your initial commit. cd $project_name"
echo ""

